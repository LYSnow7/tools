import React, { useState, useMemo, useEffect } from 'react';
import { Search, TrendingUp, TrendingDown, RefreshCw, Wifi, WifiOff } from 'lucide-react';

const StockMarketTable = () => {
  const [searchTerm, setSearchTerm] = useState('');
  const [sortField, setSortField] = useState('');
  const [sortDirection, setSortDirection] = useState('asc');
  const [selectedCategory, setSelectedCategory] = useState('全部行业');
  const [stockData, setStockData] = useState([]);
  const [loading, setLoading] = useState(false);
  const [lastUpdate, setLastUpdate] = useState(null);
  const [dataSource, setDataSource] = useState('demo');
  const [apiKey, setApiKey] = useState('0SC6QKOXXXTNIF1I');
  const [isConnected, setIsConnected] = useState(false);

  // 演示数据
  const demoData = [
    {
      code: '600519.SH',
      name: '贵州茅台',
      industry: '食品饮料',
      time: '09:31:24',
      status: '连续增长',
      changePercent: 10.00,
      price: 1925.3,
      change: 2.15,
      volume: 85260,
      turnover: 24860
    },
    {
      code: '300750.SZ',
      name: '宁德时代',
      industry: '电气设备',
      time: '10:15:32',
      status: '数据利好',
      changePercent: 20.00,
      price: 186.4,
      change: 8.92,
      volume: 156320,
      turnover: 12450
    },
    {
      code: '688122.SH',
      name: '潮记科技',
      industry: '半导体',
      time: '09:45:17',
      status: '热点题材',
      changePercent: 20.00,
      price: 386.4,
      change: 15.23,
      volume: 96720,
      turnover: 1280
    },
    {
      code: '002594.SZ',
      name: '比亚迪',
      industry: '汽车',
      time: '13:20:45',
      status: '产品创新',
      changePercent: 10.00,
      price: 652.8,
      change: 6.34,
      volume: 78450,
      turnover: 7650
    },
    {
      code: '601899.SH',
      name: '紫金矿业',
      industry: '有色金属',
      time: '14:10:22',
      status: '资产重组',
      changePercent: 10.00,
      price: 956.3,
      change: 10.27,
      volume: 65320,
      turnover: 3250
    },
    {
      code: '688777.SH',
      name: '科创智能',
      industry: '计算机',
      time: '09:25:00',
      status: '热点题材',
      changePercent: 20.00,
      price: 285.7,
      change: 22.45,
      volume: 156870,
      turnover: 860
    }
  ];

  const industries = ['全部行业', '食品饮料', '电气设备', '半导体', '汽车', '有色金属', '计算机', '银行'];

  // 初始化数据
  useEffect(() => {
    setStockData(demoData);
    setLastUpdate(new Date());
  }, []);

  // Alpha Vantage API 获取数据
  const fetchAlphaVantageData = async () => {
    if (!apiKey) {
      alert('请先设置 Alpha Vantage API Key');
      return;
    }
    
    setLoading(true);
    try {
      const symbols = ['AAPL', 'GOOGL', 'MSFT', 'TSLA', 'NVDA'];
      const fetchedStocks = [];
      
      for (const symbol of symbols) {
        try {
          console.log(`正在获取 ${symbol} 的数据...`);
          const response = await fetch(
            `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${apiKey}`
          );
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          console.log(`${symbol} 数据:`, data);
          
          if (data['Error Message']) {
            console.error(`API错误 (${symbol}):`, data['Error Message']);
            continue;
          }
          
          if (data['Note']) {
            console.warn('API限制提醒:', data['Note']);
            alert('API调用频率过高，请稍后再试');
            break;
          }
          
          const quote = data['Global Quote'];
          
          if (quote && quote['01. symbol']) {
            const changePercent = parseFloat(quote['10. change percent'].replace('%', ''));
            const price = parseFloat(quote['05. price']);
            const change = parseFloat(quote['09. change']);
            const volume = parseInt(quote['06. volume']);
            
            const stockInfo = getStockInfo(symbol);
            
            fetchedStocks.push({
              code: quote['01. symbol'],
              name: stockInfo.name,
              industry: stockInfo.industry,
              time: new Date().toLocaleTimeString(),
              status: changePercent > 5 ? '强势上涨' : changePercent > 0 ? '稳步上涨' : changePercent < -5 ? '大幅下跌' : '小幅调整',
              changePercent: changePercent,
              price: price,
              change: change,
              volume: Math.round(volume / 10000),
              turnover: Math.round(price * volume / 10000)
            });
          } else {
            console.warn(`${symbol} 数据格式异常:`, data);
          }
          
          await new Promise(resolve => setTimeout(resolve, 12000));
          
        } catch (error) {
          console.error(`获取 ${symbol} 数据失败:`, error);
        }
      }
      
      if (fetchedStocks.length > 0) {
        setStockData(fetchedStocks);
        setIsConnected(true);
        setLastUpdate(new Date());
        alert(`成功获取 ${fetchedStocks.length} 只股票的实时数据！`);
      } else {
        alert('未能获取到有效数据，请检查API Key或网络连接');
        setIsConnected(false);
      }
    } catch (error) {
      console.error('获取数据失败:', error);
      alert(`获取数据失败: ${error.message}`);
      setIsConnected(false);
    }
    setLoading(false);
  };

  // 股票信息映射
  const getStockInfo = (symbol) => {
    const stockMap = {
      'AAPL': { name: '苹果公司', industry: '科技硬件' },
      'GOOGL': { name: '谷歌', industry: '互联网' },
      'MSFT': { name: '微软', industry: '软件服务' },
      'TSLA': { name: '特斯拉', industry: '电动汽车' },
      'NVDA': { name: '英伟达', industry: '半导体' }
    };
    return stockMap[symbol] || { name: symbol, industry: '其他' };
  };

  // 刷新数据
  const refreshData = () => {
    if (dataSource === 'alphavantage') {
      fetchAlphaVantageData();
    } else {
      setStockData([...demoData]);
      setLastUpdate(new Date());
      setIsConnected(false);
    }
  };

  const filteredAndSortedData = useMemo(() => {
    let filtered = stockData.filter(stock => {
      const matchesSearch = stock.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                           stock.code.toLowerCase().includes(searchTerm.toLowerCase());
      const matchesCategory = selectedCategory === '全部行业' || stock.industry === selectedCategory;
      return matchesSearch && matchesCategory;
    });

    if (sortField) {
      filtered.sort((a, b) => {
        let aVal = a[sortField];
        let bVal = b[sortField];
        
        if (typeof aVal === 'string') {
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }
        
        if (sortDirection === 'asc') {
          return aVal > bVal ? 1 : -1;
        } else {
          return aVal < bVal ? 1 : -1;
        }
      });
    }

    return filtered;
  }, [searchTerm, selectedCategory, sortField, sortDirection, stockData]);

  const handleSort = (field) => {
    if (sortField === field) {
      setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
    } else {
      setSortField(field);
      setSortDirection('asc');
    }
  };

  const getChangeColor = (change) => {
    if (change > 0) return 'text-red-600';
    if (change < 0) return 'text-green-600';
    return 'text-gray-600';
  };

  const getStatusColor = (status) => {
    const colors = {
      '连续增长': 'bg-red-100 text-red-800',
      '数据利好': 'bg-blue-100 text-blue-800',
      '热点题材': 'bg-orange-100 text-orange-800',
      '产品创新': 'bg-purple-100 text-purple-800',
      '资产重组': 'bg-pink-100 text-pink-800',
      '强势上涨': 'bg-red-100 text-red-800',
      '稳步上涨': 'bg-green-100 text-green-800',
      '大幅下跌': 'bg-red-100 text-red-800',
      '小幅调整': 'bg-gray-100 text-gray-800'
    };
    return colors[status] || 'bg-gray-100 text-gray-800';
  };

  return (
    <div className="max-w-7xl mx-auto p-6 bg-white">
      <div className="mb-6">
        <div className="flex items-center justify-between mb-4">
          <h1 className="text-2xl font-bold text-gray-900">行业涨停表</h1>
          <div className="flex items-center gap-4">
            <div className="flex items-center gap-2">
              {isConnected ? (
                <Wifi className="w-4 h-4 text-green-500" />
              ) : (
                <WifiOff className="w-4 h-4 text-gray-400" />
              )}
              <span className="text-sm text-gray-500">
                {lastUpdate ? `更新时间: ${lastUpdate.toLocaleTimeString()}` : '未连接'}
              </span>
            </div>
            <button
              onClick={refreshData}
              disabled={loading}
              className="flex items-center gap-2 px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50"
            >
              <RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />
              刷新数据
            </button>
          </div>
        </div>

        {/* 数据源选择 */}
        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
          <h3 className="text-sm font-medium text-yellow-800 mb-2">数据源配置</h3>
          <div className="flex items-center gap-4 mb-3">
            <label className="flex items-center">
              <input
                type="radio"
                value="demo"
                checked={dataSource === 'demo'}
                onChange={(e) => setDataSource(e.target.value)}
                className="mr-2"
              />
              演示数据
            </label>
            <label className="flex items-center">
              <input
                type="radio"
                value="alphavantage"
                checked={dataSource === 'alphavantage'}
                onChange={(e) => setDataSource(e.target.value)}
                className="mr-2"
              />
              Alpha Vantage API
            </label>
          </div>
          
          {dataSource === 'alphavantage' && (
            <div className="space-y-2">
              <div className="flex items-center gap-2">
                <input
                  type="text"
                  placeholder="输入 Alpha Vantage API Key"
                  value={apiKey}
                  onChange={(e) => setApiKey(e.target.value)}
                  className="flex-1 px-3 py-2 border border-gray-300 rounded text-sm"
                />
                <button
                  onClick={fetchAlphaVantageData}
                  disabled={loading || !apiKey}
                  className="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50 text-sm"
                >
                  {loading ? '获取中...' : '获取数据'}
                </button>
              </div>
              <div className="text-xs text-orange-600 bg-orange-50 p-2 rounded">
                ⚠️ 免费版限制：每分钟5次调用，获取数据需要约1分钟请耐心等待
              </div>
            </div>
          )}
          
          <div className="text-xs text-gray-500 mt-2">
            {dataSource === 'demo' && '当前使用演示数据'}
            {dataSource === 'alphavantage' && '免费版每天500次请求，注册: https://www.alphavantage.co/support/#api-key'}
          </div>
        </div>

        {/* 统计卡片 */}
        <div className="grid grid-cols-5 gap-4 mb-6">
          <div className="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg">
            <div className="text-sm text-gray-600">涨停总数</div>
            <div className="text-2xl font-bold text-blue-600">128</div>
            <div className="text-xs text-green-600">+12.5%</div>
          </div>
          <div className="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg">
            <div className="text-sm text-gray-600">领涨行业</div>
            <div className="text-lg font-bold text-green-600">半导体</div>
            <div className="text-xs text-gray-500">5.27% 板块涨幅</div>
          </div>
          <div className="bg-gradient-to-r from-orange-50 to-orange-100 p-4 rounded-lg">
            <div className="text-sm text-gray-600">连板最高</div>
            <div className="text-lg font-bold text-orange-600">科创智能</div>
            <div className="text-xs text-gray-500">20% 今日涨幅</div>
          </div>
          <div className="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-lg">
            <div className="text-sm text-gray-600">主力净流入</div>
            <div className="text-lg font-bold text-purple-600">新能源</div>
            <div className="text-xs text-gray-500">+58亿 净流入额</div>
          </div>
          <div className="bg-gradient-to-r from-red-50 to-red-100 p-4 rounded-lg">
            <div className="text-sm text-gray-600">热门板块</div>
            <div className="text-lg font-bold text-red-600">18股</div>
            <div className="text-xs text-gray-500">58.2亿 净流入额</div>
          </div>
        </div>

        {/* 筛选和搜索 */}
        <div className="flex items-center gap-4 mb-4">
          <div className="flex gap-2">
            {industries.map(industry => (
              <button
                key={industry}
                onClick={() => setSelectedCategory(industry)}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                  selectedCategory === industry
                    ? 'bg-blue-500 text-white'
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                {industry}
              </button>
            ))}
          </div>
          <div className="relative ml-auto">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
            <input
              type="text"
              placeholder="搜索股票代码/名称"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
        </div>
      </div>

      {/* 数据表格 */}
      <div className="bg-white rounded-lg shadow-sm border overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="bg-gray-50">
              <tr>
                <th 
                  className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                  onClick={() => handleSort('code')}
                >
                  股票代码
                </th>
                <th 
                  className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                  onClick={() => handleSort('name')}
                >
                  股票名称
                </th>
                <th 
                  className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                  onClick={() => handleSort('industry')}
                >
                  所属行业
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  涨停时间
                </th>
                <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  涨停原因
                </th>
                <th 
                  className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                  onClick={() => handleSort('changePercent')}
                >
                  涨幅(%)
                </th>
                <th 
                  className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                  onClick={() => handleSort('price')}
                >
                  最新价(万手)
                </th>
                <th 
                  className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                  onClick={() => handleSort('change')}
                >
                  涨跌幅(%)
                </th>
                <th 
                  className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                  onClick={() => handleSort('volume')}
                >
                  计算金额(万元)
                </th>
                <th 
                  className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                  onClick={() => handleSort('turnover')}
                >
                  总市值(万元)
                </th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {filteredAndSortedData.map((stock, index) => (
                <tr key={stock.code} className="hover:bg-gray-50 transition-colors">
                  <td className="px-4 py-3 text-sm font-medium text-gray-900">
                    {stock.code}
                  </td>
                  <td className="px-4 py-3 text-sm text-blue-600 font-medium hover:text-blue-800 cursor-pointer">
                    {stock.name}
                  </td>
                  <td className="px-4 py-3 text-sm text-gray-600">
                    {stock.industry}
                  </td>
                  <td className="px-4 py-3 text-sm text-gray-600">
                    {stock.time}
                  </td>
                  <td className="px-4 py-3">
                    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(stock.status)}`}>
                      {stock.status}
                    </span>
                  </td>
                  <td className={`px-4 py-3 text-sm font-bold text-right ${getChangeColor(stock.changePercent)}`}>
                    <div className="flex items-center justify-end">
                      {stock.changePercent > 0 ? (
                        <TrendingUp className="w-4 h-4 mr-1" />
                      ) : stock.changePercent < 0 ? (
                        <TrendingDown className="w-4 h-4 mr-1" />
                      ) : null}
                      {stock.changePercent.toFixed(2)}
                    </div>
                  </td>
                  <td className="px-4 py-3 text-sm text-right font-medium">
                    {stock.price.toLocaleString()}
                  </td>
                  <td className={`px-4 py-3 text-sm text-right font-medium ${getChangeColor(stock.change)}`}>
                    {stock.change > 0 ? '+' : ''}{stock.change.toFixed(2)}
                  </td>
                  <td className="px-4 py-3 text-sm text-right text-gray-600">
                    {stock.volume.toLocaleString()}
                  </td>
                  <td className="px-4 py-3 text-sm text-right text-gray-600">
                    {stock.turnover.toLocaleString()}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {filteredAndSortedData.length === 0 && (
        <div className="text-center py-8 text-gray-500">
          没有找到匹配的股票数据
        </div>
      )}
    </div>
  );
};

export default StockMarketTable;
